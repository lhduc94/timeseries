# ARIMA
## Autoregressive Model
Mô hình tự hồi quy là mô hình ước lượng giá trị tương lai của timeseries dựa vào các giá trị trong quá khứ cửa chính timeseries đó.

Công thức tự hồi quy được biểu diễn như sau

$$
y_t = c + \theta_1 y_{t-1} + \theta_2 y_{t-2} + \theta_3 y_{t-3} + .... + \theta_p y_{t-p} + \epsilon_t
$$

Hoặc có thể viết lại

$$
y_t = c + \sum^{p}_{1}\theta y_{t-i} + \epsilon_t
$$

Trong đó: $\epsilon_t$ là nhiễu trắng. Có thể nói mô hình này là mô hình hồi quy đa biến với các biến là các giá trị lag tại thời điểm từ $1$ đến $p$. Chúng ta kí hiệu mô hình này là $AR(p)$

Để sử dụng AR model, ta dùng class `AutoReg` của thư viện `statsmodels`, chúng ta dùng `root_mean_squared_error` để đánh giá mô hình. Mô hình sẽ được huấn luyện và dự đoán cho 7 ngày tiếp theo

```python
from statsmodels.tsa.ar_model import AutoReg
import pandas as pd 
import numpy as np

# Đọc dữ liệu
df = pd.read_csv('../data/daily-total-female-births.csv')
df.head()

# Chia dữ liệu thành train test
Y = df.Births.values
train, test = Y[:len(Y)-7], Y[len(Y)-7:]

# Huấn luyện mô hình với p=29
model = AutoReg(train, lags=29)
model_fit = model.fit()

# Dự đoán kết quả mô hình
Y_hat = model_fit.predict(start=len(train), end=len(train)+len(test)-1, dynamic=False)
for y_hat, y_true in zip(Y_hat, test):
    print(f'Predicted={y_hat} \tExpected={y_true}')
```

```python
Predicted=41.94770376100972 	Expected=44
Predicted=39.110919166721224 	Expected=34
Predicted=39.31595241329576 	Expected=37
Predicted=41.277277685616205 	Expected=52
Predicted=42.933771871507425 	Expected=48
Predicted=42.558113213240745 	Expected=55
Predicted=41.76852911572844 	Expected=50
```

Để xem các params của mô hình ta gọi `model_fit.params`. Trong đó giá trị đầu tiên là hằng số $c$, các giá trị tiếp theo tương ứng là các $\theta$ tại các lag 

```python
model_fit.params
```

```
array([ 1.02059905e+01,  1.44428304e-01,  7.36131415e-02,  1.63274491e-02,
        4.04382220e-02,  4.36485615e-02, -2.10332720e-02,  1.38010371e-01,
        6.69075575e-02, -4.06667216e-02,  1.76155123e-02,  2.79512698e-02,
       -9.12731426e-02, -4.88545302e-02, -1.11333442e-03,  4.74045580e-02,
        4.00381240e-02, -5.00957332e-02,  2.83834804e-02,  2.70181922e-02,
        1.52596823e-02,  2.22803143e-01,  1.16878446e-02, -4.81962255e-02,
        3.11342589e-02, -3.88000648e-02, -1.77851389e-02,  6.77930532e-02,
        5.20638466e-02,  3.62816255e-03])
```

Để đánh giá kết quả mô hình, chúng ta dùng thư viện `sklearn.metrics`

```python
from sklearn.metrics import mean_squared_error
print('RMSE:', np.sqrt(mean_squared_error(test, Y_hat)))
```

```
7.548870787612078
```

Dưới đây là biểu đồ thể hiện giá trị Dự đoán và giá trị thực tế trong 7 ngày

![](../images/03/autoregressive.png)

## Moving Average Model

Thay vì sử dụng các giá trị trong quá khứ làm đầu vào để dự đoán, Moving Average Model sử dụng các lỗi dự báo của quá khứ để dự đoán giá trị tiếp theo. 

Lưu ý cần phân biệt Moving Average Smoothing và Moving Average Model.

**Moving Average Smoothing**

> Ý tưởng chính là sử dụng một cửa sổ trượt trên chuỗi dữ liệu và tính trung bình của các giá trị trong cửa sổ đó. Kết quả là chuỗi dữ liệu mới, nơi mà các dao động ngắn hạn hoặc nhiễu được giảm thiểu, giúp nhận diện xu hướng và mô hình hóa chuỗi dữ liệu dễ dàng hơn.

> Ví dụ, khi bạn thấy một chuỗi dữ liệu có nhiều dao động ngắn hạn và bạn muốn làm trơn nó để nhận diện xu hướng chung, bạn có thể sử dụng moving average smoothing để tạo ra một phiên bản làm trơn của chuỗi dữ liệu.

Công thức MA model như sau

$$
y_t = c + \theta_1 \epsilon_{t-1} + \theta_2 \epsilon_{t-2} + \theta_3 \epsilon_{t-3} + .... + \theta_q \epsilon_{t-q} + \epsilon_t 
$$
Hoặc có thể viết lại

$$
y_t = c  + \sum^{q}_{i=1}\theta_{i}\epsilon_{t-i} +  \epsilon_t
$$

Trong đó $c$ là trung bình series, $\epsilon_{t-i}$ là sai số tại $t-i$

Trong thư viện `statsmodels` không hỗ trợ chính thức cách tính **Moving Average Model**, nhưng chúng ta có thể áp dụng thông qua `ARIMA`. Ở phần sau chúng ta sẽ tìm hiểu về `ARIMA` rồi quay ngược lại ví dụ về `MA`

## AutoRegressive Moving Average Model

Như cái tên của nó, mô hình này kết hợp 2 Mô hình Autoregressive và Moving Average

Nhăc lại công thức AR

$$
y_t = c + \sum^{p}_{1}\theta y_{t-i} + \epsilon_t
$$

Và công thức MA

$$
y_t = c  + \sum^{q}_{i=1}\theta_{i}\epsilon_{t-i} +  \epsilon_t
$$

Do đó công thức ARMA là kết hợp cả hai công thức

$$
y_t = c + \epsilon_t + \sum^{p}_{1}\phi y_{t-i}  + \sum^{q}_{i=1}\theta_{i}\epsilon_{t-i}
$$

Tương tự, trong thư viện `statsmodels` không hỗ trợ chính thức cách tính **Moving Average Model**, nhưng chúng ta có thể áp dụng thông qua `ARIMA`. Ở phần sau chúng ta sẽ tìm hiểu về `ARIMA` rồi quay ngược lại ví dụ về `MA`